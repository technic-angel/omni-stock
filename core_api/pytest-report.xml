<?xml version="1.0" encoding="utf-8"?><testsuites name="pytest tests"><testsuite name="pytest" errors="0" failures="1" skipped="0" tests="1" time="1.344" timestamp="2025-11-16T03:33:31.760318+00:00" hostname="a521630f70bc"><testcase classname="collectibles.tests.test_openapi_schema" name="test_openapi_schema_matches_baseline" time="1.255"><failure message="assert '{&quot;components...ctibles&quot;]}}}}' == '{&quot;components...ctibles&quot;]}}}}'&#10;  &#10;  Skipping 4437 identical leading characters in diff, use -v to show&#10;  #x1B[0m#x1B[91m- object&quot;},&quot;TokenObtainPair&quot;:{&quot;properties&quot;:{&quot;access&quot;:{&quot;readOnly&quot;:true,&quot;type&quot;:&quot;string&quot;},&quot;password&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;writeOnly&quot;:true},&quot;refresh&quot;:{&quot;readOnly&quot;:true,&quot;type&quot;:&quot;string&quot;},&quot;username&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;writeOnly&quot;:true}},&quot;required&quot;:[&quot;access&quot;,&quot;password&quot;,&quot;refresh&quot;,&quot;username&quot;],&quot;type&quot;:&quot;object&quot;},&quot;TokenRefresh&quot;:{&quot;properties&quot;:{&quot;access&quot;:{&quot;readOnly&quot;:true,&quot;type&quot;:&quot;string&quot;},&quot;refresh&quot;:{&quot;type&quot;:&quot;string&quot;}},&quot;required&quot;:[&quot;access&quot;,&quot;refresh&quot;],&quot;type&quot;:&quot;object&quot;},&quot;TokenVerify&quot;:{&quot;properties&quot;:{&quot;token&quot;:{&quot;type&quot;:&quot;string&quot;,&quot;...&#10;  &#10;  ...Full output truncated (2 lines hidden), use '-vv' to show">@pytest.mark.django_db
    def test_openapi_schema_matches_baseline():
        """Generate the OpenAPI schema and compare against committed baseline.
    
        This test guards against accidental API contract changes.
        """
        # Ensure the lightweight CI settings are used so schema generation
        # is deterministic and doesn't require Postgres or other services.
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'omni_stock.schema_generate_settings')
    
        # generate schema to stdout and capture
        with tempfile.NamedTemporaryFile(mode='w+', suffix='.json') as tmp:
            # request JSON output to match the committed baseline
            call_command('spectacular', '--format', 'openapi-json', stdout=tmp)
            tmp.flush()
            tmp.seek(0)
            generated = json.load(tmp)
    
        # Baseline may exist at core_api/api_schema.json or at repo root api_schema.json
        possible = ['core_api/api_schema.json', 'api_schema.json']
        for p in possible:
            try:
                with open(p, 'r', encoding='utf-8') as fh:
                    baseline = json.load(fh)
                break
            except FileNotFoundError:
                baseline = None
        assert baseline is not None, f"Baseline schema not found at any of {possible}"
    
        # Canonicalize JSON (sort keys) to avoid incidental ordering differences
        def canonical(obj):
            return json.dumps(obj, sort_keys=True, separators=(',', ':'))
    
        gen_norm = canonical(generated)
        base_norm = canonical(baseline)
    
&gt;       assert gen_norm == base_norm
E       assert '{"components...ctibles"]}}}}' == '{"components...ctibles"]}}}}'
E         
E         Skipping 4437 identical leading characters in diff, use -v to show
E         #x1B[0m#x1B[91m- object"},"TokenObtainPair":{"properties":{"access":{"readOnly":true,"type":"string"},"password":{"type":"string","writeOnly":true},"refresh":{"readOnly":true,"type":"string"},"username":{"type":"string","writeOnly":true}},"required":["access","password","refresh","username"],"type":"object"},"TokenRefresh":{"properties":{"access":{"readOnly":true,"type":"string"},"refresh":{"type":"string"}},"required":["access","refresh"],"type":"object"},"TokenVerify":{"properties":{"token":{"type":"string","...
E         
E         ...Full output truncated (2 lines hidden), use '-vv' to show

collectibles/tests/test_openapi_schema.py:44: AssertionError</failure></testcase></testsuite></testsuites>